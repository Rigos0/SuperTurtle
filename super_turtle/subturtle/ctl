#!/usr/bin/env bash
set -euo pipefail

# --- Configuration ---
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "${SCRIPT_DIR}/../.." && pwd)"
SUBTURTLES_DIR="${PROJECT_DIR}/.subturtles"

# Use subturtle venv if available, otherwise system python3
PYTHON="${SCRIPT_DIR}/.venv/bin/python3"
if [[ ! -x "$PYTHON" ]]; then
  PYTHON="python3"
fi

usage() {
  echo "Usage: ./super_turtle/subturtle/ctl <command> [name]"
  echo ""
  echo "Commands:"
  echo "  start  [name]   Spawn a SubTurtle (default name: 'default')"
  echo "  stop   [name]   Stop a SubTurtle gracefully"
  echo "  status [name]   Check if a SubTurtle is running"
  echo "  logs   [name]   Tail a SubTurtle's log"
  echo "  list            List all SubTurtles and their status"
  echo ""
  echo "Each SubTurtle gets its own workspace at .subturtles/<name>/ with"
  echo "its own CLAUDE.md, AGENTS.md symlink, PID file, and log file."
  exit 1
}

# Resolve the workspace directory for a named SubTurtle
workspace_dir() {
  local name="${1:-default}"
  echo "${SUBTURTLES_DIR}/${name}"
}

pid_file()  { echo "$(workspace_dir "$1")/subturtle.pid"; }
log_file()  { echo "$(workspace_dir "$1")/subturtle.log"; }

ensure_workspace() {
  local name="${1:-default}"
  local ws
  ws="$(workspace_dir "$name")"

  mkdir -p "$ws"

  # Create CLAUDE.md if it doesn't exist yet — seed from root if available
  if [[ ! -f "$ws/CLAUDE.md" ]]; then
    if [[ -f "$PROJECT_DIR/CLAUDE.md" ]]; then
      cp "$PROJECT_DIR/CLAUDE.md" "$ws/CLAUDE.md"
      echo "[subturtle:${name}] seeded CLAUDE.md from project root"
    else
      cat > "$ws/CLAUDE.md" <<'SEED'
# Current task

(no task set)

# End goal with specs

(not defined yet)

# Roadmap (Completed)

- (none yet)

# Roadmap (Upcoming)

- (none yet)

# Backlog

- [ ] Define end goal and first tasks <- current
- [ ] (placeholder 2)
- [ ] (placeholder 3)
- [ ] (placeholder 4)
- [ ] (placeholder 5)
SEED
      echo "[subturtle:${name}] created empty CLAUDE.md"
    fi
  fi

  # Create AGENTS.md symlink if missing
  if [[ ! -L "$ws/AGENTS.md" ]]; then
    ln -sf CLAUDE.md "$ws/AGENTS.md"
  fi
}

is_running() {
  local pf
  pf="$(pid_file "$1")"
  if [[ -f "$pf" ]]; then
    local pid
    pid="$(cat "$pf")"
    if kill -0 "$pid" 2>/dev/null; then
      return 0
    fi
  fi
  return 1
}

read_pid() {
  cat "$(pid_file "$1")" 2>/dev/null || echo ""
}

do_start() {
  local name="${1:-default}"
  ensure_workspace "$name"

  if is_running "$name"; then
    echo "[subturtle:${name}] already running (PID $(read_pid "$name"))"
    exit 0
  fi

  local pf lf ws
  pf="$(pid_file "$name")"
  lf="$(log_file "$name")"
  ws="$(workspace_dir "$name")"

  rm -f "$pf"

  echo "[subturtle:${name}] spawning..."
  echo "[subturtle:${name}] workspace: ${ws}"
  echo "[subturtle:${name}] log: ${lf}"

  # Spawn the SubTurtle module in a new session via start_new_session=True.
  # This calls os.setsid() in the child, giving it its own session
  # and process group — unreachable by the parent's group signals.
  # The launcher exits immediately; child process is orphaned to PID 1.
  "$PYTHON" -c "
import subprocess, sys, os

pid_file   = sys.argv[1]
log_file   = sys.argv[2]
python     = sys.argv[3]
cwd        = sys.argv[4]
state_dir  = sys.argv[5]
name       = sys.argv[6]

env = os.environ.copy()
# Strip Claude Code session vars so child can spawn its own claude processes
for key in list(env):
    if key.startswith('CLAUDECODE'):
        del env[key]

log_fd = open(log_file, 'w')
proc = subprocess.Popen(
    [python, '-u', '-m', 'super_turtle.subturtle', '--state-dir', state_dir, '--name', name],
    cwd=cwd,
    stdin=subprocess.DEVNULL,
    stdout=log_fd,
    stderr=log_fd,
    start_new_session=True,
    env=env,
)
log_fd.close()

with open(pid_file, 'w') as f:
    f.write(str(proc.pid))

print(f'[subturtle:{name}] spawned (PID {proc.pid})')
" "$pf" "$lf" "$PYTHON" "$PROJECT_DIR" "$ws" "$name"
}

do_stop() {
  local name="${1:-default}"

  if ! is_running "$name"; then
    echo "[subturtle:${name}] not running"
    rm -f "$(pid_file "$name")"
    exit 0
  fi

  local pid
  pid="$(read_pid "$name")"
  echo "[subturtle:${name}] stopping (PID ${pid})..."

  kill "$pid" 2>/dev/null || true

  local i
  for i in $(seq 1 10); do
    if ! kill -0 "$pid" 2>/dev/null; then
      echo "[subturtle:${name}] stopped"
      rm -f "$(pid_file "$name")"
      return
    fi
    sleep 1
  done

  echo "[subturtle:${name}] sending SIGKILL..."
  kill -9 "$pid" 2>/dev/null || true
  rm -f "$(pid_file "$name")"
  echo "[subturtle:${name}] killed"
}

do_status() {
  local name="${1:-default}"

  if is_running "$name"; then
    local pid
    pid="$(read_pid "$name")"
    echo "[subturtle:${name}] running (PID ${pid})"
    ps -o pid,ppid,pgid,sess,state,etime,command -p "$pid" 2>/dev/null || true
  else
    echo "[subturtle:${name}] not running"
    rm -f "$(pid_file "$name")"
  fi
}

do_logs() {
  local name="${1:-default}"
  local lf
  lf="$(log_file "$name")"

  if [[ ! -f "$lf" ]]; then
    echo "[subturtle:${name}] no log file found at ${lf}"
    exit 1
  fi
  tail -n "${LINES:-50}" -f "$lf"
}

do_list() {
  if [[ ! -d "$SUBTURTLES_DIR" ]]; then
    echo "No SubTurtles found."
    return
  fi

  local found=0
  for ws in "$SUBTURTLES_DIR"/*/; do
    [[ -d "$ws" ]] || continue
    local name
    name="$(basename "$ws")"
    found=1

    local status_str="stopped"
    local pid_str=""
    local pf="${ws}subturtle.pid"
    if [[ -f "$pf" ]]; then
      local pid
      pid="$(cat "$pf")"
      if kill -0 "$pid" 2>/dev/null; then
        status_str="running"
        pid_str=" (PID ${pid})"
      fi
    fi

    # Read current task from this SubTurtle's CLAUDE.md
    local task="(no task)"
    if [[ -f "${ws}CLAUDE.md" ]]; then
      task="$(sed -n '/^# Current task/,/^# /{/^# /!p;}' "${ws}CLAUDE.md" | grep -v '^$' | head -1 | sed 's/ *<- current$//')"
      [[ -z "$task" ]] && task="(no task)"
    fi

    printf "  %-15s %-8s%s  %s\n" "$name" "$status_str" "$pid_str" "$task"
  done

  if [[ $found -eq 0 ]]; then
    echo "No SubTurtles found."
  fi
}

# --- Main ---
if [[ $# -lt 1 ]]; then
  usage
fi

CMD="$1"
NAME="${2:-default}"

case "$CMD" in
  start)  do_start "$NAME" ;;
  stop)   do_stop "$NAME" ;;
  status) do_status "$NAME" ;;
  logs)   do_logs "$NAME" ;;
  list)   do_list ;;
  *)      usage ;;
esac
